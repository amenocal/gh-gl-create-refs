# gh-gl-create-refs

A GitHub CLI extension to fetch GitLab merge request references and export them as CSV files.

## Installation

This is a GitHub CLI extension. To install it:

```bash
gh extension install amenocal/gh-gl-create-refs
```

## Usage

### Prerequisites

You need a GitLab access token to use this extension. You can create one in GitLab under **User Settings > Access Tokens**.

Set your token either as an environment variable:

```bash
export GITLAB_TOKEN=your_token_here
```

Or pass it via the `--token` flag.

### Fetch Merge Request References

Use the `fetch-refs` command to fetch all merge request references from a GitLab repository:

```bash
# Using environment variable for token
gh gl-create-refs fetch-refs group/project

# Using token flag
gh gl-create-refs fetch-refs --token your_token group/project

# With custom GitLab instance
gh gl-create-refs fetch-refs --base-url https://gitlab.example.com group/project

# With custom output file
gh gl-create-refs fetch-refs --output my_output.csv group/project
```

### Create Branches from References

Use the `create-refs` command to create GitLab branches from merge request references:

```bash
# Create branches from a CSV file
gh gl-create-refs create-refs --input group-project.csv --repository group/project

# Create branches with target repository specified
gh gl-create-refs create-refs -i refs.csv -r group/project --target target-group/target-project --token your_token

# Fetch merge requests and create branches in real-time
gh gl-create-refs create-refs --repository source-group/source-project --fetch

# Real-time fetch with target repository and custom GitLab instance
gh gl-create-refs create-refs -r source/repo --target target/repo --fetch --base-url https://gitlab.example.com

# Test with mock mode (safe - no actual branches created)
gh gl-create-refs create-refs --repository source/repo --fetch --mock

# Mock mode with CSV file
gh gl-create-refs create-refs -i refs.csv -r group/project --mock
```

### Supported Repository Formats

The extension supports various GitLab repository path formats:

- **Group/Project**: `group/project`
- **Nested Subgroups**: `group/subgroup/project`
- **Multiple Nested Subgroups**: `group/sub1/sub2/sub3/project`
- **Full URLs**: `https://gitlab.com/group/project`
- **Custom GitLab Instance URLs**: `https://gitlab.example.com/group/project`

### Output Format

The extension generates a CSV file with two columns:

1. **Merge Request Number** (IID) - The merge request number as shown in GitLab UI
2. **Head SHA** - The head commit SHA from the merge request's diff_refs

Example output (`group-project.csv`):

```csv
1,e8a44ccde03fc255605d38aec8db81db176398eb
16,f70267410222c85b3ea62df436acef0de0e9bda3
17,d47c8f40a570e567e6672b54528a4cc34c29eb60
```

### Command Options

#### fetch-refs Command

- `--token`, `-t`: GitLab access token (can also use `GITLAB_TOKEN` environment variable)
- `--base-url`, `-b`: GitLab base URL (default: https://gitlab.com)
- `--output`, `-o`: Custom output CSV file path (default: auto-generated from repository name)
- `--repository`, `-r`: GitLab repository path (required)

#### create-refs Command

- `--input`, `-i`: Input CSV file path (required unless `--fetch` is used)
- `--repository`, `-r`: Source GitLab repository path (required)
- `--target`: Target GitLab repository path where branches will be created (optional, defaults to repository)
- `--token`, `-t`: GitLab access token (can also use `GITLAB_TOKEN` environment variable)
- `--base-url`, `-b`: GitLab base URL (default: https://gitlab.com)  
- `--fetch`: Fetch merge requests in real-time instead of using CSV file
- `--mock`: Mock mode - simulate branch creation without actually creating branches (safe for testing)

## Examples

### Fetch Examples

```bash
# Fetch from gitlab.com
gh gl-create-refs fetch-refs mygroup/myproject

# Fetch from custom GitLab instance
gh gl-create-refs fetch-refs --base-url https://gitlab.company.com company/team/project

# Fetch with custom output file
gh gl-create-refs fetch-refs --output results.csv mygroup/subgroup/project

# Fetch from full URL
gh gl-create-refs fetch-refs https://gitlab.com/mygroup/myproject
```

### Create Refs Examples

```bash
# Create branches from CSV file generated by fetch-refs
gh gl-create-refs create-refs --input mygroup-myproject.csv --repository mygroup/myproject --target target-group/target-repo

# Create branches with authentication token
gh gl-create-refs create-refs -i refs.csv -r source/project --target company/migration-repo --token glpat-xxxxxxxxxxxxxxxxxxxx

# Fetch and create branches in one command
gh gl-create-refs create-refs --repository source-group/source-project --target migration-group/migration-repo --fetch

# Use with custom GitLab instance
gh gl-create-refs create-refs -r company/old-project --target company/new-project --fetch --base-url https://gitlab.company.com

# Test with mock mode first (safe - no actual branches created)
gh gl-create-refs create-refs --repository source-group/source-project --fetch --mock

# Mock mode with CSV file for testing
gh gl-create-refs create-refs -i refs.csv -r source/project --mock

# After testing, create real branches
gh gl-create-refs create-refs --repository source-group/source-project --target target-group/target-project --fetch
```

### Branch Naming

The `create-refs` command creates branches following the pattern `migration-pr-<PRNumber>`:

- PR #1 → `migration-pr-1`
- PR #16 → `migration-pr-16`  
- PR #123 → `migration-pr-123`

### Mock Mode (Testing)

The `--mock` flag provides a safe way to test your configuration without actually creating branches:

```bash
# Test with mock mode to see what would be created
gh gl-create-refs create-refs --repository source/repo --fetch --mock
```

In mock mode, the command will:

- ✅ Validate your configuration and credentials
- ✅ Fetch merge request references (if using `--fetch`)
- ✅ Parse CSV files (if using `--input`)
- ✅ Display exactly which branches would be created
- ✅ Show the format: `Created branch migration-pr-123 with sha: abc123def456`
- ❌ **NOT** actually create any branches in GitLab

This allows you to verify everything is working correctly before running the real command.

## Typical Workflow

### Recommended Process (with Mock Testing)

1. **Test with mock mode first (safe):**

   ```bash
   gh gl-create-refs create-refs --repository source-group/source-project --fetch --mock
   # Verify configuration and see what would be created
   ```

2. **Fetch merge request references to CSV:**

   ```bash
   gh gl-create-refs fetch-refs --repository source-group/source-project
   # This creates source-group-source-project.csv
   ```

3. **Create branches from the CSV:**

   ```bash
   gh gl-create-refs create-refs --input source-group-source-project.csv --repository source-group/source-project --target target-group/target-project
   ```

### One-Step Process (Alternative)

For immediate processing without intermediate CSV storage:

```bash
# Test first
gh gl-create-refs create-refs --repository source-group/source-project --target target-group/target-project --fetch --mock

# Then create for real
gh gl-create-refs create-refs --repository source-group/source-project --target target-group/target-project --fetch
```

## Development

### Building

```bash
go build -o gh-gl-create-refs
```

### Testing

```bash
go test ./...
```

## Requirements

- Go 1.19 or later
- GitLab access token with read access to the target repository
- GitHub CLI (gh) for installation as an extension

## License

[View License](LICENSE)
