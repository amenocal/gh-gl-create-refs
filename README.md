# gh-gl-create-refs

A GitHub CLI extension to fetch GitLab merge request references and export them as CSV files.

## Installation

This is a GitHub CLI extension. To install it:

```bash
gh extension install amenocal/gh-gl-create-refs
```

## Usage

### Prerequisites

You need a GitLab access token to use this extension. You can create one in GitLab under **User Settings > Access Tokens**.

Set your token either as an environment variable:
```bash
export GITLAB_TOKEN=your_token_here
```

Or pass it via the `--token` flag.

### Fetch Merge Request References

Use the `fetch-refs` command to fetch all merge request references from a GitLab repository:

```bash
# Using environment variable for token
gh gl-create-refs fetch-refs group/project

# Using token flag
gh gl-create-refs fetch-refs --token your_token group/project

# With custom GitLab instance
gh gl-create-refs fetch-refs --base-url https://gitlab.example.com group/project

# With custom output file
gh gl-create-refs fetch-refs --output my_output.csv group/project
```

### Create Branches from References

Use the `create-refs` command to create GitLab branches from merge request references:

```bash
# Create branches from a CSV file
gh gl-create-refs create-refs --input group-project.csv --target target-group/target-project

# Using token flag and custom GitLab instance
gh gl-create-refs create-refs -i refs.csv --target target/repo --token your_token --base-url https://gitlab.example.com

# Fetch merge requests and create branches in real-time
gh gl-create-refs create-refs --repository source-group/source-project --target target-group/target-project --fetch

# Real-time fetch with custom GitLab instance
gh gl-create-refs create-refs -r source/repo --target target/repo --fetch --base-url https://gitlab.example.com
```

### Supported Repository Formats

The extension supports various GitLab repository path formats:

- **Group/Project**: `group/project`
- **Nested Subgroups**: `group/subgroup/project`
- **Multiple Nested Subgroups**: `group/sub1/sub2/sub3/project`
- **Full URLs**: `https://gitlab.com/group/project`
- **Custom GitLab Instance URLs**: `https://gitlab.example.com/group/project`

### Output Format

The extension generates a CSV file with two columns:
1. **Merge Request Number** (IID) - The merge request number as shown in GitLab UI
2. **Head SHA** - The head commit SHA from the merge request's diff_refs

Example output (`group-project.csv`):
```csv
1,e8a44ccde03fc255605d38aec8db81db176398eb
16,f70267410222c85b3ea62df436acef0de0e9bda3
17,d47c8f40a570e567e6672b54528a4cc34c29eb60
```

### Command Options

#### fetch-refs Command
- `--token`, `-t`: GitLab access token (can also use `GITLAB_TOKEN` environment variable)
- `--base-url`, `-b`: GitLab base URL (default: https://gitlab.com)
- `--output`, `-o`: Custom output CSV file path (default: auto-generated from repository name)
- `--repository`, `-r`: GitLab repository path (required)

#### create-refs Command
- `--input`, `-i`: Input CSV file path (required unless `--fetch` is used)
- `--target`: Target GitLab repository path where branches will be created (required)
- `--repository`, `-r`: Source GitLab repository path (used with `--fetch`)
- `--token`, `-t`: GitLab access token (can also use `GITLAB_TOKEN` environment variable)
- `--base-url`, `-b`: GitLab base URL (default: https://gitlab.com)  
- `--fetch`: Fetch merge requests in real-time instead of using CSV file

## Examples

### Fetch Examples
```bash
# Fetch from gitlab.com
gh gl-create-refs fetch-refs mygroup/myproject

# Fetch from custom GitLab instance
gh gl-create-refs fetch-refs --base-url https://gitlab.company.com company/team/project

# Fetch with custom output file
gh gl-create-refs fetch-refs --output results.csv mygroup/subgroup/project

# Fetch from full URL
gh gl-create-refs fetch-refs https://gitlab.com/mygroup/myproject
```

### Create Refs Examples
```bash
# Create branches from CSV file generated by fetch-refs
gh gl-create-refs create-refs --input mygroup-myproject.csv --target target-group/target-repo

# Create branches with authentication token
gh gl-create-refs create-refs -i refs.csv --target company/migration-repo --token glpat-xxxxxxxxxxxxxxxxxxxx

# Fetch and create branches in one command
gh gl-create-refs create-refs --repository source-group/source-project --target migration-group/migration-repo --fetch

# Use with custom GitLab instance
gh gl-create-refs create-refs -r company/old-project --target company/new-project --fetch --base-url https://gitlab.company.com
```

### Branch Naming
The `create-refs` command creates branches following the pattern `migration-pr-<PRNumber>`:
- PR #1 → `migration-pr-1`
- PR #16 → `migration-pr-16`  
- PR #123 → `migration-pr-123`

## Typical Workflow

### Two-Step Process (Recommended)
1. **Fetch merge request references to CSV:**
   ```bash
   gh gl-create-refs fetch-refs --repository source-group/source-project
   # This creates source-group-source-project.csv
   ```

2. **Create branches from the CSV:**
   ```bash
   gh gl-create-refs create-refs --input source-group-source-project.csv --target target-group/target-project
   ```

### One-Step Process (Alternative)
For immediate processing without intermediate CSV storage:
```bash
gh gl-create-refs create-refs --repository source-group/source-project --target target-group/target-project --fetch
```

## Development

### Building

```bash
go build -o gh-gl-create-refs
```

### Testing

```bash
go test ./...
```

## Requirements

- Go 1.19 or later
- GitLab access token with read access to the target repository
- GitHub CLI (gh) for installation as an extension

## License

[View License](LICENSE)